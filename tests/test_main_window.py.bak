"""GUI tests for the MainWindow application."""

from __future__ import annotations

import datetime as dt
from unittest.mock import MagicMock, patch

import pytest
from pytestqt.qtbot import QtBot

from app.ui.main_window import MainWindow
from app.validation import ScheduleRequest


@pytest.fixture
def mock_api():
    """Create a mock calendar API."""
    api = MagicMock()
    api.list_calendars.return_value = (
        ["Work Calendar", "Personal Calendar"],
        {"Work Calendar": "work123", "Personal Calendar": "personal456"},
    )
    return api


@pytest.fixture
def main_window(qtbot: QtBot, mock_api) -> MainWindow:
    """Create a MainWindow for testing."""
    with patch("app.ui.main_window.CalendarApi", return_value=mock_api):
        window = MainWindow(api=mock_api)
        qtbot.addWidget(window)
        yield window
        window.close()


class TestMainWindowCreation:
    """Tests for MainWindow initialization."""

    def test_window_title(self, main_window: MainWindow):
        """Test that window has correct title."""
        assert "Vacation Calendar Updater" in main_window.windowTitle()

    def test_calendar_combo_populated(self, main_window: MainWindow):
        """Test that calendar combo box is populated."""
        combo = main_window.calendar_combo
        assert combo.count() == 2
        assert combo.itemText(0) == "Work Calendar"
        assert combo.itemText(1) == "Personal Calendar"

    def test_process_button_exists(self, main_window: MainWindow):
        """Test that Insert Into Calendar button exists."""
        assert main_window.process_button is not None
        assert main_window.process_button.text() == "Insert Into Calendar"

    def test_undo_combo_exists(self, main_window: MainWindow):
        """Test that undo combo box exists."""
        assert main_window.undo_combo is not None
        assert main_window.undo_combo.isEnabled()

    def test_undo_button_exists(self, main_window: MainWindow):
        """Test that undo button exists."""
        assert main_window.undo_button is not None
        assert main_window.undo_button.text() == "Undo Selected"


class TestMainWindowValidation:
    """Tests for form validation and button states."""

    def test_insert_button_disabled_initially(self, qtbot: QtBot, main_window: MainWindow):
        """Test that Insert button is disabled when no weekdays selected."""
        # All weekdays are unchecked by default in the mock
        assert not main_window.process_button.isEnabled()

    def test_insert_button_enabled_when_weekday_selected(
        self, qtbot: QtBot, main_window: MainWindow
    ):
        """Test that Insert button becomes enabled when a weekday is selected."""
        # Select Monday checkbox
        monday_box = main_window.weekday_boxes["monday"]
        monday_box.setChecked(True)

        # Button should now be enabled (assuming other fields are valid)
        # Note: May still be disabled if other fields are empty
        # This tests the validation connection works

    def test_email_validation_triggers_on_text_change(self, qtbot: QtBot, main_window: MainWindow):
        """Test that email validation is triggered on text change."""
        # Clear the email field
        main_window.notification_email.clear()

        # Enter a valid email
        main_window.notification_email.setText("test@example.com")

        # Enter invalid email - should trigger validation
        main_window.notification_email.setText("invalid-email")

        # Validation should run (button state updates)


class TestMainWindowScheduleCalculation:
    """Tests for schedule building and display."""

    def test_days_label_updates_on_validation(self, qtbot: QtBot, main_window: MainWindow):
        """Test that days label updates when schedule is valid."""
        # Set up valid form data
        main_window.event_name.setText("Test Event")
        main_window.notification_email.setText("test@example.com")

        # Select a weekday
        monday_box = main_window.weekday_boxes["monday"]
        monday_box.setChecked(True)

        # Set start and end dates
        start_date = main_window.start_date
        end_date = main_window.end_date

        # Set dates (QDate)
        start_date.setDate(2024, 1, 1)  # Monday
        end_date.setDate(2024, 1, 7)  # Sunday

        # Days label should update from "check settings" to actual value
        label_text = main_window.days_label.text()
        assert label_text != "check settings"


class TestMainWindowUndo:
    """Tests for undo functionality UI."""

    def test_undo_combo_empty_initially(self, main_window: MainWindow):
        """Test that undo combo is empty when no undo history."""
        assert main_window.undo_combo.count() == 0

    def test_undo_button_disabled_initially(self, main_window: MainWindow):
        """Test that undo button is disabled when no undo history."""
        assert not main_window.undo_button.isEnabled()

    def test_undo_combo_populated_after_insert(self, qtbot: QtBot, main_window: MainWindow):
        """Test that undo combo is populated after a successful insert."""
        # Create a mock undo batch
        from app.validation import UndoBatch

        mock_batch = UndoBatch(
            batch_id="test-123",
            created_at=dt.datetime.now(),
            events=[],
            description="Test insert",
        )

        # Add to undo manager
        main_window.undo_manager.record_batch(mock_batch)

        # Combo should now have one item
        assert main_window.undo_combo.count() == 1


class TestMainWindowSettings:
    """Tests for settings persistence."""

    def test_settings_loaded_on_start(self, main_window: MainWindow):
        """Test that settings are loaded from config on startup."""
        # Settings should be loaded (may be default if no config file)
        assert main_window.settings is not None

    def test_settings_saved_on_validation_success(self, qtbot: QtBot, main_window: MainWindow):
        """Test that settings are saved when form is valid."""
        # Set up valid form
        main_window.event_name.setText("Test Event")
        main_window.notification_email.setText("test@example.com")
        monday_box = main_window.weekday_boxes["monday"]
        monday_box.setChecked(True)

        # Select calendar
        main_window.calendar_combo.setCurrentIndex(0)

        # Settings should be saved
        assert main_window.settings.calendar == "Work Calendar"


class TestMainWindowLogArea:
    """Tests for the log area."""

    def test_log_area_exists(self, main_window: MainWindow):
        """Test that log area exists."""
        assert main_window.log_box is not None
        assert main_window.log_box.isReadOnly()


class TestMainWindowEventName:
    """Tests for event name field."""

    def test_event_name_field_exists(self, main_window: MainWindow):
        """Test that event name field exists."""
        assert main_window.event_name is not None

    def test_event_name_validation_empty(self, qtbot: QtBot, main_window: MainWindow):
        """Test that empty event name shows error."""
        main_window.event_name.clear()
        # Validation should run and disable button
        assert not main_window.process_button.isEnabled()
