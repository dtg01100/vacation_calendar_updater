"""GUI tests for the DatePicker widget."""

from __future__ import annotations

import datetime as dt

import pytest
from pytestqt.qtbot import QtBot

from PySide6 import QtCore

from app.ui.datepicker import DatePicker


@pytest.fixture
def datepicker(qtbot: QtBot) -> DatePicker:
    """Create a DatePicker for testing."""
    picker = DatePicker()
    qtbot.addWidget(picker)
    yield picker
    picker.close()


class TestDatePickerCreation:
    """Tests for DatePicker initialization."""

    def test_datepicker_is_qdateedit(self, datepicker: DatePicker):
        """Test that DatePicker is a QDateEdit."""
        assert datepicker is not None

    def test_calendar_popup_enabled(self, datepicker: DatePicker):
        """Test that calendar popup is enabled."""
        assert datepicker.calendarPopup()

    def test_display_format(self, datepicker: DatePicker):
        """Test that display format is set correctly."""
        assert "yyyy-MM-dd" in datepicker.displayFormat()

    def test_default_date_is_today(self, datepicker: DatePicker):
        """Test that default date is today."""
        today = dt.date.today()
        picker_date = datepicker.date().toPython()
        assert picker_date == today


class TestDatePickerNavigation:
    """Tests for date navigation shortcuts."""

    def test_select_delta_days_backward(self, qtbot: QtBot, datepicker: DatePicker):
        """Test Ctrl+Left decreases date by 1 day."""
        initial_date = datepicker.date().toPython()
        qtbot.keyPress(datepicker, "Left", modifier=QtCore.Qt.KeyboardModifier.ControlModifier)
        new_date = datepicker.date().toPython()
        assert new_date == initial_date - dt.timedelta(days=1)

    def test_select_delta_days_forward(self, qtbot: QtBot, datepicker: DatePicker):
        """Test Ctrl+Right increases date by 1 day."""
        initial_date = datepicker.date().toPython()
        qtbot.keyPress(datepicker, "Right", modifier=QtCore.Qt.KeyboardModifier.ControlModifier)
        new_date = datepicker.date().toPython()
        assert new_date == initial_date + dt.timedelta(days=1)

    def test_select_week_backward(self, qtbot: QtBot, datepicker: DatePicker):
        """Test Ctrl+Up decreases date by 7 days."""
        initial_date = datepicker.date().toPython()
        qtbot.keyPress(datepicker, "Up", modifier=QtCore.Qt.KeyboardModifier.ControlModifier)
        new_date = datepicker.date().toPython()
        assert new_date == initial_date - dt.timedelta(days=7)

    def test_select_week_forward(self, qtbot: QtBot, datepicker: DatePicker):
        """Test Ctrl+Down increases date by 7 days."""
        initial_date = datepicker.date().toPython()
        qtbot.keyPress(datepicker, "Down", modifier=QtCore.Qt.KeyboardModifier.ControlModifier)
        new_date = datepicker.date().toPython()
        assert new_date == initial_date + dt.timedelta(days=7)

    def test_step_month_backward(self, qtbot: QtBot, datepicker: DatePicker):
        """Test Ctrl+PgUp decreases month by 1."""
        initial_date = datepicker.date().toPython()
        qtbot.keyPress(datepicker, "PageUp", modifier=QtCore.Qt.KeyboardModifier.ControlModifier)
        new_date = datepicker.date().toPython()
        expected_month = initial_date.month - 1 if initial_date.month > 1 else 12
        expected_year = initial_date.year - (1 if initial_date.month == 1 else 0)
        assert new_date.year == expected_year and new_date.month == expected_month

    def test_step_month_forward(self, qtbot: QtBot, datepicker: DatePicker):
        """Test Ctrl+PgDown increases month by 1."""
        initial_date = datepicker.date().toPython()
        qtbot.keyPress(datepicker, "PageDown", modifier=QtCore.Qt.KeyboardModifier.ControlModifier)
        new_date = datepicker.date().toPython()
        expected_month = initial_date.month + 1 if initial_date.month < 12 else 1
        expected_year = initial_date.year + (1 if initial_date.month == 12 else 0)
        assert new_date.year == expected_year and new_date.month == expected_month

    def test_select_today_shortcut(self, qtbot: QtBot, datepicker: DatePicker):
        """Test Ctrl+Home selects today's date."""
        # Change date first
        datepicker.setDate(QtCore.QDate(2020, 1, 1))
        qtbot.keyPress(datepicker, "Home", modifier=QtCore.Qt.KeyboardModifier.ControlModifier)
        today = dt.date.today()
        picker_date = datepicker.date().toPython()
        assert picker_date == today


class TestDatePickerErase:
    """Tests for erase functionality."""

    def test_erase_clears_date(self, qtbot: QtBot, datepicker: DatePicker):
        """Test that erase (Ctrl+End) clears the date."""
        datepicker.setDate(QtCore.QDate(2024, 6, 15))
        datepicker.erase()
        # erase() calls clear() which sets to invalid date
        assert not datepicker.date().isValid()


class TestDatePickerPopup:
    """Tests for calendar popup functionality."""

    def test_calendar_widget_exists(self, datepicker: DatePicker):
        """Test that calendar widget is set."""
        assert datepicker.calendarWidget() is not None

    def test_calendar_has_grid(self, datepicker: DatePicker):
        """Test that calendar widget has grid visible."""
        calendar = datepicker.calendarWidget()
        assert calendar.isGridVisible()
